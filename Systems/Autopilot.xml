<?xml version="1.0"?>
 
<PropertyList>
    <!-- autopilot modes of operation:
        auto~leveller ~ recover from any pitch and roll to straight and level flight
            ~ i'm thinking pitch matches alpha for level flight
            ~ roll will be standard "get your wings to 0 bank"
        
        stabilize ~ 2 channels, bank and pitch.
            ~ bank is set to 0 if bank is less than 6, otherwise hold that bank.
            ~ to override, aileron command must be greater than ~0.15 (probably will want to tune that)
            ~ bank hold works up to 80* pitch
            ~ pitch is set to hold whatever is commanded
            ~ can be overridden by elevator input greater than ~0.10 (probably will want to tune that)
            
        low altitude mode ~ if the plane hits a selected altitude, climb and hold another altitude
            ~ altitude climbed to can be anywhere from 20m to 150 m above the danger altitude
            ~ probably the lower the danger alt, the higher the "safe altitude"
            ~ will handle the figuring~out~the~safe~alt using a listener in autopilot.nas
            
        ils ~ follow localizer and glideslope
            ~ to be used for approaches, not full landings


check for Low Altitude Mode
 conditions
        if the low alt switch is on and 
            the danger light is on
            or
            low alt mode has been already triggered

 autopilot.nas has a listener for /autopilot/locks/low~alt~mode to set safe altitude
    
 if the pilot goes below the alt limit, the autopilot kicks in and 
    says nah, climb to this altitude.
    if, during the climb, the alt limit is re~exceeded, then the
    new climb altitude must be computed.

    ergo:
    alt limit is hit, continuously compute new alt until above the alt limit
-->

    <state-machine>

        <branch>/autopilot/low-level-state-machine</branch>

        <state>
            <name>monitor</name>
            <enter></enter>
            <exit></exit>
            <update></update>
        </state>

        <state>
            <name>climb</name>
            <enter></enter>
            <exit></exit>
            <update>
                <command>nasal</command>
                <script>radar_altimeter.calc_safe_altitude();</script>
            </update>
        </state>

        <transition>
            <name>ready</name>
            <source>monitor</source>
            <target>climb</target>
            <exclude-target type="bool">true</exclude-target>
            <condition>
                <!--<property>/autopilot/locks/low-alt-mode</property>-->
                <greater-than>
                    <property>/instrumentation/altimeter/altitude-limit-select-ft</property>
                    <property>/position/altitude-agl-ft</property>
                </greater-than>
            </condition>
            <binding>
                <command>nasal</command>
                <script>print('triggered2');</script>
            </binding>
        </transition>

        <transition>
            <name>ready</name>
            <source>climb</source>
            <target>monitor</target>
            <exclude-target type="bool">false</exclude-target>
            <condition>
                <not>
                    <property>/autopilot/locks/low-alt-mode</property>
                </not>
                <less-than>
                    <property>/instrumentation/altimeter/altitude-limit-select-ft</property>
                    <property>/position/altitude-agl-ft</property>
                </less-than>
            </condition>
            <binding>
                <command>nasal</command>
                <script>print('triggered2');</script>
            </binding>
        </transition>


    </state-machine>

</PropertyList>