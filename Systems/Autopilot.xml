<?xml version="1.0"?>
 
<PropertyList>
    <!-- autopilot modes of operation:
        auto~leveller ~ recover from any pitch and roll to straight and level flight
            ~ i'm thinking pitch matches alpha for level flight
            ~ roll will be standard "get your wings to 0 bank"
        
        stabilize ~ 2 channels, bank and pitch.
            ~ bank is set to 0 if bank is less than 6, otherwise hold that bank.
            ~ to override, aileron command must be greater than ~0.15 (probably will want to tune that)
            ~ bank hold works up to 80* pitch
            ~ pitch is set to hold whatever is commanded
            ~ can be overridden by elevator input greater than ~0.10 (probably will want to tune that)
            
        low altitude mode ~ if the plane hits a selected altitude, climb and hold another altitude
            ~ altitude climbed to can be anywhere from 20m to 150 m above the danger altitude
            ~ probably the lower the danger alt, the higher the "safe altitude"
            ~ will handle the figuring~out~the~safe~alt using a listener in autopilot.nas
            
        ils ~ follow localizer and glideslope
            ~ to be used for approaches, not full landings


check for Low Altitude Mode
 conditions
        if the low alt switch is on and 
            the danger light is on
            or
            low alt mode has been already triggered

 autopilot.nas has a listener for /autopilot/locks/low~alt~mode to set safe altitude
    
 if the pilot goes below the alt limit, the autopilot kicks in and 
    says nah, climb to this altitude.
    if, during the climb, the alt limit is re~exceeded, then the
    new climb altitude must be computed.

    ergo:
    alt limit is hit, continuously compute new alt until above the alt limit
-->

<!-- modes:
    0 is off
    1 is low-alt
    2 is leveler
    3 is stabilizer
    4 is ils
-->

    <filter>
        <name>Calculate Safe Altitude</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <condition>
                <equals>
                    <property>/autopilot/internal/safe-altitude-switch</property>
                    <value>1</value>
                </equals>
            </condition>
            <expression>
                <sum>
                    <dif>
                        <property>/instrumentation/altimeter/indicated-altitude-ft</property>
                        <property>/instrumentation/altimeter/radar-altimeter-ft</property>
                    </dif>
                    <property>/instrumentation/altimeter/altitude-limit-select-ft</property>
                    <product>
                        <value>3.280839895013123</value>
                        <sum>
                            <value>150</value>
                            <product>
                                <value>-130</value>
                                <div>
                                    <dif>
                                        <product>
                                            <property>/instrumentation/altimeter/altitude-limit-select-ft</property>
                                            <value>0.3048</value>
                                        </product>
                                        <value>20</value>
                                    </dif>
                                    <value>580</value>
                                </div>
                            </product>
                        </sum>
                    </product>
                </sum>
            </expression>
        </input>
        <output>/autopilot/internal/safe-alt-calc</output>
    </filter>

    <state-machine>

        <branch>/autopilot/low-level-state-machine</branch>

        <state>
            <name>monitor</name>
            <enter>
                <command>nasal</command>
                <script>
                    setprop("/autopilot/internal/safe-alt",getprop("/autopilot/internal/safe-alt-calc"));
                    setprop("/autopilot/internal/safe-altitude-switch",0);
                </script>
            </enter>
            <exit>
                <binding>
                    <command>nasal</command>
                    <script>autopilot.panel_button("low-alt");</script>
                </binding>
            </exit>
            <update></update>
        </state>

        <state>
            <name>climb</name>
            <enter></enter>
            <exit>
                <command>property-assign</command>
                <property>/autopilot/internal/safe-altitude-switch</property>
                <value>0</value>
            </exit>
            <update>
                <command>property-assign</command>
                <property>/autopilot/internal/safe-altitude-switch</property>
                <value>1</value>
            </update>
        </state>

        <transition>
            <name>ready</name>
            <source>monitor</source>
            <target>climb</target>
            <exclude-target type="bool">true</exclude-target>
            <condition>
                <property>/autopilot/locks/low-alt-mode-enabled</property>>
                <greater-than>
                    <property>/instrumentation/altimeter/altitude-limit-select-ft</property>
                    <property>/position/altitude-agl-ft</property>
                </greater-than>
            </condition>
            <binding>
            </binding>
        </transition>

        <transition>
            <name>ready</name>
            <source>climb</source>
            <target>monitor</target>
            <exclude-target type="bool">false</exclude-target>
            <condition>
                <not>
                    <property>/autopilot/locks/mode</property>
                    <value>1</value>
                </not>
                <less-than>
                    <property>/instrumentation/altimeter/altitude-limit-select-ft</property>
                    <property>/position/altitude-agl-ft</property>
                </less-than>
            </condition>
            <binding>
            </binding>
        </transition>

    </state-machine>

<!-- the actual low-alt pids -->
    
    <pid-controller>
        <name>Low Altitude Recovery</name>
        <debug>false</debug>
        <enable>
            <property>/autopilot/locks/mode</property>
            <value>1</value>
        </enable>
        <input>
            <property>/instrumentation/altimeter/indicated-altitude-ft</property>
        </input>
        <reference>
            <property>/autopilot/internal/safe-alt</property>
        </reference>
        <output>
            <property>/autopilot/internal/target-pitch-rate-degps</property>
        </output>
        <config>
            <Kp>0.05</Kp>
            <Ti>100000000000</Ti>
            <Td>0.0000</Td>
            <u_min>-10.0</u_min>
            <u_max>10.0</u_max>
        </config>
    </pid-controller>
    
<!-- auto-leveler -->

<!-- Start with 0 for Ki and Kd, and tune Kp until it moves big enough, but not oscilating. 
Then increase Ki to get rid of steady state error, if its too high, it will oscillate. Then 
increase Kd which will help to stop overshoot and damped the output a bit -->


    
    <filter>
        <name>PITCH KP (P Gain)</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <expression>
                <table>
                    <property>/velocities/mach</property>
                    <entry><ind>0.3</ind><dep>-0.7</dep></entry>
                    <entry><ind>1.7</ind><dep>-0.1</dep></entry>
                </table>
            </expression>
        </input>
        <output>/autopilot/internal/pitch-rate-kp</output>
    </filter>


    <pid-controller>
        <name>Auto-Leveler Pitch</name>
        <debug>false</debug>
        <enable>
            <property>/autopilot/locks/mode</property>
            <value>2</value>
        </enable>
        <input>
            <property>/velocities/vertical-speed-fps</property>
        </input>
        <reference>
            <value>0</value>
        </reference>
        <output>
            <property>/autopilot/internal/target-pitch-rate-degps</property>
        </output>
        <config>
            <Kp>0.05</Kp>
            <Ti>7</Ti>
            <Td>0.0003</Td>
            <u_min>-10.0</u_min>
            <u_max>10.0</u_max>
        </config>
    </pid-controller>

    <filter>
        <name>Autoleveller and Low altitude roll level setting</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <condition>
                <or>
                    <equals>
                        <condition>/autopilot/locks/mode</condition>
                        <value>1</value>
                    </equals>
                    <equals>
                        <condition>/autopilot/locks/mode</condition>
                        <value>2</value>
                    </equals>
                </or>
            </condition>
            <expression>
                <value>0</value>
            </expression>
        </input>
        <output>/orientation/roll-deg</output>
    </filter>

    <pid-controller>
        <name>Roll-deg controller</name>
        <debug>false</debug>
        <enable>
            <prop>/autopilot/locks/mode</prop>
            <value>2</value>
        </enable>
        <input>
            <prop>/orientation/roll-deg</prop>
        </input>
        <reference>
            <property>/autopilot/internal/target-roll</property>
        </reference>
        <output>
            <prop>/autopilot/internal/target-roll-rate-degps</prop>
        </output>
        <config>
            <Kp>3.6</Kp>
            <Ti>0.5</Ti>
            <Td>0.00000</Td>
            <u_min>-15.0</u_min>
            <u_max>15.0</u_max>
        </config>
    </pid-controller>

    <!-- pitch/roll final controllers -->

    <pid-controller>
        <name>Auto-Leveler Pitch Stage 2</name>
        <debug>false</debug>
        <enable>
            <property>/autopilot/locks/mode</property>
            <value>2</value>
        </enable>
        <input>
            <property>/orientation/pitch-rate-degps</property>
        </input>
        <reference>
            <property>/autopilot/internal/target-pitch-rate-degps</property>
        </reference>
        <output>
            <property>/fdm/jsbsim/fcs/elevator-ap-cmd-norm</property>
        </output>
        <config>
            <Kp><property>/autopilot/internal/pitch-rate-kp</property></Kp>
            <Ti>0.5</Ti>
            <Td>0.0002</Td>
            <u_min>-1.0</u_min>
            <u_max>1.0</u_max>
        </config>
    </pid-controller>

    <pid-controller>
        <name>Auto-Leveler Roll Stage 2</name>
        <debug>false</debug>
        <enable>
            <prop>/autopilot/locks/mode</prop>
            <value>2</value>
        </enable>
        <input>
            <prop>/orientation/roll-rate-degps</prop>
        </input>
        <reference>
            <property>/autopilot/internal/target-roll-rate-degps</property>
        </reference>
        <output>
            <prop>/fdm/jsbsim/fcs/aileron-ap-cmd-norm</prop>
        </output>
        <config>
            <Kp>0.025</Kp>
            <Ti>0.5</Ti>
            <Td>0.0002</Td>
            <u_min>-1.0</u_min>
            <u_max>1.0</u_max>
        </config>
    </pid-controller>

    <!-- stabilizer state machines (one per channel) -->

    <state-machine>
        <branch>/autopilot/stabilizer-roll-state-machine</branch>

        <state>
        </state>
    </state-machine>

    <state-machine>
        <branch>/autopilot/stabilizer-pitch-state-machine</branch>

        <state>
        </state>
    </state-machine>

    <!-- stabilizer pids -->

    <!-- ILS pids -->

</PropertyList>