<?xml version="1.0"?>
 
<PropertyList>
    <!-- autopilot modes of operation:
        auto~leveller ~ recover from any pitch and roll to straight and level flight
            ~ i'm thinking pitch matches alpha for level flight
            ~ roll will be standard "get your wings to 0 bank"
        
        stabilize ~ 2 channels, bank and pitch.
            ~ bank is set to 0 if bank is less than 6, otherwise hold that bank.
            ~ to override, aileron command must be greater than ~0.15 (probably will want to tune that)
            ~ bank hold works up to 80* pitch
            ~ pitch is set to hold whatever is commanded
            ~ can be overridden by elevator input greater than ~0.10 (probably will want to tune that)
            
        low altitude mode ~ if the plane hits a selected altitude, climb and hold another altitude
            ~ altitude climbed to can be anywhere from 20m to 150 m above the danger altitude
            ~ probably the lower the danger alt, the higher the "safe altitude"
            ~ will handle the figuring~out~the~safe~alt using a listener in autopilot.nas
            
        ils ~ follow localizer and glideslope
            ~ to be used for approaches, not full landings


check for Low Altitude Mode
 conditions
        if the low alt switch is on and 
            the danger light is on
            or
            low alt mode has been already triggered

 autopilot.nas has a listener for /autopilot/locks/low~alt~mode to set safe altitude
    
 if the pilot goes below the alt limit, the autopilot kicks in and 
    says nah, climb to this altitude.
    if, during the climb, the alt limit is re~exceeded, then the
    new climb altitude must be computed.

    ergo:
    alt limit is hit, continuously compute new alt until above the alt limit
-->

<!-- modes:
    0 is off
    1 is low-alt
    2 is leveler
    3 is stabilizer
    4 is ils
-->

    <filter>
        <name>Calculate Safe Altitude</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <condition>
                <equals>
                    <property>/autopilot/internal/safe-altitude-switch</property>
                    <value>1</value>
                </equals>
            </condition>
            <expression>
                <sum>
                    <dif>
                        <property>/instrumentation/altimeter/indicated-altitude-ft</property>
                        <property>/instrumentation/altimeter/radar-altimeter-ft</property>
                    </dif>
                    <property>/instrumentation/altimeter/altitude-limit-select-ft</property>
                    <product>
                        <value>3.280839895013123</value>
                        <sum>
                            <value>150</value>
                            <product>
                                <value>-130</value>
                                <div>
                                    <dif>
                                        <product>
                                            <property>/instrumentation/altimeter/altitude-limit-select-ft</property>
                                            <value>0.3048</value>
                                        </product>
                                        <value>20</value>
                                    </dif>
                                    <value>580</value>
                                </div>
                            </product>
                        </sum>
                    </product>
                </sum>
            </expression>
        </input>
        <output>/autopilot/internal/safe-alt-calc</output>
    </filter>

    <state-machine>
        <!-- 
            properties used:
            ./internal/safe-alt-calc            calculate the safe altitude to climb to
            ./internal/safe-alt                 actual safe altitude to climb to
            ./internal/safe-altitude-switch     run the safe altitude calculation algorithm
            ./locks/low-alt-mode-armed          the low-alt mode is armed and primed to run
        -->

        <branch>/autopilot/state-machines/low-alt</branch>

        <state>
            <name>off</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/locks/mode</property>
                <value>0</value>
            </enter>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/internal/safe-altitude-switch</property>
                <value>0</value>
            </enter>
        </state>

        <state>
            <name>off-no-ap-set</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/internal/safe-altitude-switch</property>
                <value>0</value>
            </enter>
        </state>

        <state>
            <name>armed</name>
        </state>

        <state>
            <name>danger-alt</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/internal/safe-altitude-switch</property>
                <value>1</value>
            </enter>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/locks/mode</property>
                <value>1</value>
            </enter>
            <exit>
                <command>property-assign</command>
                <property>/autopilot/internal/safe-altitude-switch</property>
                <value>0</value>
            </exit>
            <update>
                <command>property-assign</command>
                <property>/autopilot/internal/safe-alt</property>
                <property>/autopilot/internal/safe-alt-calc</property>
            </update>
        </state>

        <state>
            <name>altitude-hold</name>
        </state>

        <transition>
            <name>off-to-armed</name>
            <source>off</source>
            <source>off-no-ap-set</source>
            <target>armed</target>
            <exclude-target type="bool">true</exclude-target>
            <condition>
                <equals>
                    <property>/autopilot/locks/low-alt-mode-armed</property>
                    <value>1</value>
                </equals>
            </condition>
            <binding>
            </binding>
        </transition>

        <transition>
            <name>armed-to-danger-alt</name>
            <sourcee>armed</sourcee>
            <target>danger-alt</target>
            <exclude-target type="bool">true</exclude-target>
            <condition>
                <and>
                    <equals>
                        <property>/autopilot/locks/low-alt-mode-armed</property>
                        <value>1</value>
                    </equals>
                    <greater-than>
                        <property>/instrumentation/altimeter/altitude-limit-select-ft</property>
                        <property>/position/altitude-agl-ft</property>
                    </greater-than>
                </and>
            </condition>
            <binding>
            </binding>
        </transition>

        <transition>
            <name>danger-alt-to-altitude-hold</name>
            <source>danger-alt</source>
            <target>altitude-hold</target>
            <exclude-target type="bool">true</exclude-target>
            <condition>
                <and>
                    <equals>
                        <property>/autopilot/locks/low-alt-mode-armed</property>
                        <value>1</value>
                    </equals>
                    <less-than>
                        <property>/instrumentation/altimeter/altitude-limit-select-ft</property>
                        <property>/position/altitude-agl-ft</property>
                    </less-than>
                </and>
            </condition>
            <binding>
            </binding>
        </transition>

        <transition>
            <name>disable-ap</name>
            <source>danger-alt</source>
            <source>altitude-hold</source>
            <target>off</target>
            <exclude-target type="bool">true</exclude-target>
            <condition>
                <or>
                    <equals>
                        <property>/autopilot/locks/low-alt-mode-armed</property>
                        <value>0</value>
                    </equals>
                    <equals>
                        <property>/autopilot/locks/mode</property>
                        <value>0</value>
                    </equals>
                    <greater-than>
                        <property>/fdm/jsbsim/fcs/aileron-cmd-norm</property>
                        <value>0.3</value>
                    </greater-than>
                    <less-than>
                        <property>/fdm/jsbsim/fcs/aileron-cmd-norm</property>
                        <value>-0.3</value>
                    </less-than>
                    <greater-than>
                        <property>/fdm/jsbsim/fcs/elevator-cmd-norm</property>
                        <value>0.3</value>
                    </greater-than>
                    <less-than>
                        <property>/fdm/jsbsim/fcs/elevator-cmd-norm</property>
                        <value>-0.3</value>
                    </less-than>
                    <greater-than>
                        <property>/fdm/jsbsim/fcs/rudder-cmd-norm</property>
                        <value>0.3</value>
                    </greater-than>
                    <less-than>
                        <property>/fdm/jsbsim/fcs/rudder-cmd-norm</property>
                        <value>-0.3</value>
                    </less-than>
                </or>
            </condition>
            <binding>
            </binding>
        </transition>

        <transition>
            <name>disable-ap-2</name>
            <source>danger-alt</source>
            <source>altitude-hold</source>
            <target>off-no-ap-set</target>
            <exclude-target type="bool">true</exclude-target>
            <condition>
                <greater-than>
                    <property>/autopilot/locks/mode</property>
                    <value>1</value>
                </greater-than>
            </condition>
            <binding>
            </binding>
        </transition>

    </state-machine>


<!-- the actual low-alt pids -->

    <pid-controller>
        <name>Low Altitude Recovery Stage 1</name>
        <debug>false</debug>
        <enable>
            <property>/autopilot/locks/mode</property>
            <value>1</value>
        </enable>
        <input>
            <property>/instrumentation/altimeter/indicated-altitude-ft</property>
        </input>
        <reference>
            <property>/autopilot/internal/safe-alt</property>
        </reference>
        <output>
            <property>/autopilot/internal/target-vs</property>
        </output>
        <config>
            <Kp>0.21</Kp>
            <Ti>11</Ti>
            <Td>0.001</Td>
            <u_min>-300.0</u_min>
            <u_max>300.0</u_max>
        </config>
    </pid-controller>
    
    <pid-controller>
        <name>Low Altitude Recovery Stage 2</name>
        <debug>false</debug>
        <enable>
            <property>/autopilot/locks/mode</property>
            <value>1</value>
        </enable>
        <input>
            <property>/velocities/vertical-speed-fps</property>
        </input>
        <reference>
            <property>/autopilot/internal/target-vs</property>
        </reference>
        <output>
            <property>/autopilot/internal/target-pitch-rate-degps</property>
        </output>
        <config>
            <Kp>0.05</Kp>
            <Ti>7</Ti>
            <Td>0.0003</Td>
            <u_min>-10.0</u_min>
            <u_max>10.0</u_max>
        </config>
    </pid-controller>
    
<!-- auto-leveler -->

    <state-machine>

        <branch>/autopilot/state-machines/autoleveller</branch>

        <state>
            <name>off</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/locks/mode</property>
                <value>0</value>
            </enter>
        </state>

        <state>
            <name>off-no-ap-set</name>
        </state>

        <state>
            <name>active</name>
        </state>

        <transition>
            <name>off-to-active</name>
            <source>off</source>
            <source>off-no-ap-set</source>
            <target>active</target>
            <condition>
                <equals>
                    <property>/autopilot/locks/mode</property>
                    <value>2</value>
                </equals>
            </condition>
        </transition>

        <transition>
            <name>active-to-off</name>
            <source>active</source>
            <target>off</target>
            <condition>
                <or>
                    <equals>
                        <property>/autopilot/locks/mode</property>
                        <value>0</value>
                    </equals>
                    <greater-than>
                        <property>/fdm/jsbsim/fcs/aileron-cmd-norm</property>
                        <value>0.3</value>
                    </greater-than>
                    <less-than>
                        <property>/fdm/jsbsim/fcs/aileron-cmd-norm</property>
                        <value>-0.3</value>
                    </less-than>
                    <greater-than>
                        <property>/fdm/jsbsim/fcs/elevator-cmd-norm</property>
                        <value>0.3</value>
                    </greater-than>
                    <less-than>
                        <property>/fdm/jsbsim/fcs/elevator-cmd-norm</property>
                        <value>-0.3</value>
                    </less-than>
                    <greater-than>
                        <property>/fdm/jsbsim/fcs/rudder-cmd-norm</property>
                        <value>0.3</value>
                    </greater-than>
                    <less-than>
                        <property>/fdm/jsbsim/fcs/rudder-cmd-norm</property>
                        <value>-0.3</value>
                    </less-than>
                </or>
            </condition>
        </transition>

        <transition>
            <name>active-to-off-no-ap-set</name>
            <source>active</source>
            <target>off-no-ap-set</target>
            <condition>
                <not-equals>
                    <property>/autopilot/locks/mode</property>
                    <value>2</value>
                </not-equals>
            </condition>
        </transition>

    </state-machine>

    
    <filter>
        <name>PITCH KP (P Gain)</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <expression>
                <table>
                    <property>/velocities/mach</property>
                    <entry><ind>0.3</ind><dep>-0.8</dep></entry>
                    <entry><ind>1.7</ind><dep>-0.2</dep></entry>
                </table>
            </expression>
        </input>
        <output>/autopilot/internal/pitch-rate-kp</output>
    </filter>


    <pid-controller>
        <name>Auto-Leveler Pitch</name>
        <debug>false</debug>
        <enable>
            <property>/autopilot/locks/mode</property>
            <value>2</value>
        </enable>
        <input>
            <property>/velocities/vertical-speed-fps</property>
        </input>
        <reference>
            <value>0</value>
        </reference>
        <output>
            <property>/autopilot/internal/target-pitch-rate-degps</property>
        </output>
        <config>
            <Kp>0.05</Kp>
            <Ti>7</Ti>
            <Td>0.0003</Td>
            <u_min>-10.0</u_min>
            <u_max>10.0</u_max>
        </config>
    </pid-controller>

    <filter>
        <name>Autoleveller and Low altitude roll level setting</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <condition>
                <or>
                    <equals>
                        <property>/autopilot/locks/mode</property>
                        <value>1</value>
                    </equals>
                    <equals>
                        <property>/autopilot/locks/mode</property>
                        <value>2</value>
                    </equals>
                </or>
            </condition>
            <expression>
                <value>0</value>
            </expression>
        </input>
        <output>/autopilot/internal/target-roll</output>
    </filter>

    <pid-controller>
        <name>Roll-deg controller</name>
        <debug>false</debug>
        <enable>
            <condition>
                <or>
                    <equals>
                        <property>/autopilot/locks/mode</property>
                        <value>1</value>
                    </equals>
                    <equals>
                        <property>/autopilot/locks/mode</property>
                        <value>2</value>
                    </equals>
                </or>
            </condition>
        </enable>
        <input>
            <prop>/orientation/roll-deg</prop>
        </input>
        <reference>
            <property>/autopilot/internal/target-roll</property>
        </reference>
        <output>
            <prop>/autopilot/internal/target-roll-rate-degps</prop>
        </output>
        <config>
            <Kp>3.6</Kp>
            <Ti>0.5</Ti>
            <Td>0.00000</Td>
            <u_min>-15.0</u_min>
            <u_max>15.0</u_max>
        </config>
    </pid-controller>

    <!-- pitch/roll final controllers -->

    <pid-controller>
        <name>Pitch Final</name>
        <debug>false</debug>
        <enable>
            <condition>
                <greater-than>
                    <property>/autopilot/locks/mode</property>
                    <value>0</value>
                </greater-than>
                <less-than>
                    <property>/fdm/jsbsim/fcs/elevator-manual-override</property>
                    <value>0.5</value>
                </less-than>
            </condition>
        </enable>
        <input>
            <property>/orientation/pitch-rate-degps</property>
        </input>
        <reference>
            <property>/autopilot/internal/target-pitch-rate-degps</property>
        </reference>
        <output>
            <property>/fdm/jsbsim/fcs/elevator-ap-cmd-norm</property>
        </output>
        <config>
            <Kp><property>/autopilot/internal/pitch-rate-kp</property></Kp>
            <Ti>0.5</Ti>
            <Td>0.0002</Td>
            <u_min>-1.0</u_min>
            <u_max>1.0</u_max>
        </config>
    </pid-controller>

    <pid-controller>
        <name>Roll Final</name>
        <debug>false</debug>
        <enable>
            <condition>
                <greater-than>
                    <property>/autopilot/locks/mode</property>
                    <value>0</value>
                </greater-than>
                <less-than>
                    <property>/fdm/jsbsim/fcs/aileron-manual-override</property>
                    <value>0.5</value>
                </less-than>
            </condition>
        </enable>
        <input>
            <property>/orientation/roll-rate-degps</property>
        </input>
        <reference>
            <property>/autopilot/internal/target-roll-rate-degps</property>
        </reference>
        <output>
            <property>/fdm/jsbsim/fcs/aileron-ap-cmd-norm</property>
        </output>
        <config>
            <Kp>0.025</Kp>
            <Ti>0.5</Ti>
            <Td>0.0002</Td>
            <u_min>-1.0</u_min>
            <u_max>1.0</u_max>
        </config>
    </pid-controller>

    <!-- stabilizer state machines (one per channel) -->



    <!-- stabilizer pids -->

    <!-- ILS pids -->

</PropertyList>